<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- iOS Safari -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <!-- Chrome, Firefox OS and Opera Status Bar Color -->
  <meta name="theme-color" content="#FFFFFF">
  
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
  <link rel="stylesheet" type="text/css"
    href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
  <link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
  <link rel="stylesheet" type="text/css" href="css/notablog.css">
  <link rel="stylesheet" type="text/css" href="css/theme.css">
  <style>
    :root {
      font-size: 18px;
    }

    .DateTagBar {
      margin-top: 1.0rem;
    }

    hr.style14 { 
      border: 0; 
      height: 1px; 
      background-image: -webkit-linear-gradient(left, #f0f0f0, #8c8b8b, #f0f0f0);
      background-image: -moz-linear-gradient(left, #f0f0f0, #8c8b8b, #f0f0f0);
      background-image: -ms-linear-gradient(left, #f0f0f0, #8c8b8b, #f0f0f0);
      background-image: -o-linear-gradient(left, #f0f0f0, #8c8b8b, #f0f0f0); 
    }

  </style>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-ET8JZXS5LE"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-ET8JZXS5LE');
</script>

  <title>Building a better baby movement monitor&nbsp;|&nbsp;unvarnished</title>
  <meta property="og:type" content="blog">
  <meta property="og:title" content="Building a better baby movement monitor">
  
    <meta name="description" content="I build an eyes-free baby movement monitor that alerts via audio tones. Can use any iOS baby monitor app as input video feed.">
    <meta property="og:description" content="I build an eyes-free baby movement monitor that alerts via audio tones. Can use any iOS baby monitor app as input video feed.">
  
  
    <meta property="og:image" content="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F27840c54-c4dd-4461-b598-63f0dee697d3%2Farticle.png?table=block&amp;id=d179354c-4a48-474a-9133-373bdfb3ba70">
  
  <style>
    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
  <a href="index.html">
    <div class="Navbar__Btn">
      
        <span><img class="inline-img-icon" src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F320633e8-3085-4580-acbd-ebf160eeed36%2Fhome.png?table=collection&amp;id=c028b1e3-fce7-415e-96c6-cf8b2be3919a"></span>&nbsp;
      
      <span>Home</span>
    </div>
  </a>
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="about.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Ff0df78d3-1d44-498e-8227-78001f637913%2Fabout.png?table=block&amp;id=b5ef726c-6168-43f7-ab47-4080e6397bed"></span>&nbsp;
          
          <span>About</span>
        </div>
      </a>
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="photography.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F34a8a292-8ecd-460a-9845-834872a45c7a%2Fcamera.png?table=block&amp;id=81e721b8-8434-44d4-a045-f04a6894fadc"></span>&nbsp;
          
          <span>Photography</span>
        </div>
      </a>
    
  
    
  
    
  
    
  
</nav>
  <header class="Header">
    
    <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
    
      <div class="Header__Icon">
        <span><img class="inline-img-icon" src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F27840c54-c4dd-4461-b598-63f0dee697d3%2Farticle.png?table=block&amp;id=d179354c-4a48-474a-9133-373bdfb3ba70"></span>
      </div>
    
    <h1 class="Header__Title">Building a better baby movement monitor</h1>
    
      <div class="DateTagBar">
        
          <span class="DateTagBar__Item DateTagBar__Date">Posted on Tue, Nov 30, 2021</span>
        
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--purple">
            <a href="tag/tech.html">tech</a>
          </span>
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--blue">
            <a href="tag/perspective.html">perspective</a>
          </span>
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--default">
            <a href="tag/childcare.html">childcare</a>
          </span>
        
      </div>
    
  </header>
  <article id="https://www.notion.so/d179354c4a48474a9133373bdfb3ba70" class="PageRoot"><blockquote id="https://www.notion.so/7945044dda7b4438a20c86d67f61ecbd" class="ColorfulBlock ColorfulBlock--ColorDefault Quote"><span class="SemanticStringArray"><span class="SemanticString">TLDR: I build an eyes-free baby movement monitor that alerts via audio tones. It can use any iOS baby monitor app as input video feed.</span></span></blockquote><div id="https://www.notion.so/a1a9baf005964e03a13bc508917635d3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/c97359c2cc244077b528106c4f82ad8b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">When my son was born I bought the Nanit, a baby monitor that came highly recommended. Its video and background audio monitoring worked very well. When he was small he would cry every time he woke up. That was our cue to rush and take care of him. At around 7 months of age this behavior changed. He would wake up, sit up, move around, climb on pillows, try to get off the bed and sometimes even disconnected the camera unit from it&#x27;s base, all done silently like a ninja. Needless to say background audio monitoring did not cut it anymore. So my wife and I started monitoring the Nanit video as we did household chores, when we had conversations, when we read books and yes even in the restroom. Our attention was divided. We couldn&#x27;t rest and recover after putting him to bed. What we needed was a &#x27;baby is waking up&#x27; alert that didn&#x27;t hijack our senses and let us be present when we did other things.</span></span></p></div><div id="https://www.notion.so/0851101752b14f888db8282812e504b5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h3 id="https://www.notion.so/59ac8ccb55864359b944cccdd676bb53" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/59ac8ccb55864359b944cccdd676bb53"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Problem</span></span></h3><div id="https://www.notion.so/7deb043d2ca6465098ed03b42ac1dfc7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The Nanit (and many other video monitors) offer movement alerts. But they work well only under ideal conditions. Like many other parents we don&#x27;t use the Nanit camera overhead as it is designed. Our son sleeps on a floor bed. We simply point it at him from a short bedside table. Curtains moving in the wind or changing shadows cast by the sunlight can trigger these alerts. I could live with these false positives; It is the false negatives that are a deal breaker. For whatever reason these alerts are unreliable on iOS. On many occasions I&#x27;ve walked in on my son dancing around the mattress and received no alerts. It is unclear whether it is the Nanit camera that fails to trigger the alert or whether the message is dropped. I think it is a little of both. Either way, after fiddling with the alert sensitivity settings, I&#x27;ve given up. Even when the alerts deliver it is too easy to miss the message chime, which sadly can&#x27;t be customized on iOS.</span></span></p></div><div id="https://www.notion.so/d3fa691db198432d98d57dbf34a1b4b6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h3 id="https://www.notion.so/32293caf011d401cb5b9d5ee78580aed" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/32293caf011d401cb5b9d5ee78580aed"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Prototype 1</span></span></h3><div id="https://www.notion.so/ebfdb51695d74767bad44f09f45bcca3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">I needed a camera feed and video stream monitoring to trigger these alarms myself. I prototyped a motion monitor with my macbook&#x27;s webcam. This camera needed a LOT of light to produce a decent picture with its tiny sensor. When deployed, it didn&#x27;t even work in the daytime in a dimly lit room. I needed to increase the screen brightness all the way to a point that would affect his sleep quality (image below). We couldn&#x27;t use this.</span></span></p></div><div id="https://www.notion.so/ccd4dedbe9f74a8ea3057f0a6e5be734" class="Image Image--Normal"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F33f1f1d0-d80f-45a3-8512-e4d5af9accd2%2FUntitled.png?width=336&amp;table=block&amp;id=ccd4dedb-e9f7-4a8e-a305-7f0a6e5be734"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F33f1f1d0-d80f-45a3-8512-e4d5af9accd2%2FUntitled.png?width=336&amp;table=block&amp;id=ccd4dedb-e9f7-4a8e-a305-7f0a6e5be734" style="width:336px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/86327e20a9b44c1fb6f9e62122a13304" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h3 id="https://www.notion.so/4b1c82fe65e44675980b4c9de48a3e55" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/4b1c82fe65e44675980b4c9de48a3e55"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Prototype 2</span></span></h3><div id="https://www.notion.so/1572799d2991450aad8303214cf7a7cc" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">I figured phone cameras have gotten much better. So I set up </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://www.elgato.com/en/epoccam">epocCam</a></span><span class="SemanticString"> to use my unused iPhone&#x27;s camera as a remote webcamera. It was better but not good enough. It worked in the daytime but not in the night for the same reason as the macbook webcam. At this point I realized that the Nanit camera is great at produce a clear image regardless of the ambient light, using it&#x27;s backup infrared camera. I didn&#x27;t have to reinvent the wheel. I just needed a way to plug into the Nanit&#x27;s feed. I wanted to run the Nanit app on my macbook and use that as a video feed. But the app was not available in the Mac app store or Android app store on the android emulator.</span></span></p></div><div id="https://www.notion.so/d101eb4230c045f093ae3653144860ca" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h3 id="https://www.notion.so/4d5d8882c2c74b2aab23107ca0e1a191" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/4d5d8882c2c74b2aab23107ca0e1a191"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Solution</span></span></h3><div id="https://www.notion.so/7830626e7f3a4a9f9e326becaa2c8386" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">I learnt that Quicktime allows you to record the iPhone screen when connected via the lightning cable. Simple. All I had to do was connect my phone to my laptop with the app running. My monitoring job samples screenshots of the Quicktime app, detects movements and triggers alerts. Easy peasy. This worked. In fact this worked so well, that we&#x27;ve even been able to enjoy movies without worry. We get alerts on his movements right as they happen with the same source of truth (the Nanit video stream) we&#x27;ve come to trust. The alerts are sounded in a tone that encodes the intensity of the movement. This further helps us understand if he is simply turning or is up and around. When these alerts sound we turn to look at the laptop screen to see the video stream which is far more convenient than looking at the phone.</span></span></p></div><div id="https://www.notion.so/8e5aac98eb13402587fe2fb1f59f0984" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h3 id="https://www.notion.so/9337b009cb7a438481a82c4a33213597" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/9337b009cb7a438481a82c4a33213597"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Code</span></span></h3><pre id="https://www.notion.so/6638513fec10455083c0af36199d9d42" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token comment">#!/usr/bin/python3</span>

<span class="token keyword">import</span> collections
<span class="token keyword">import</span> ffmpeg
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> scipy <span class="token keyword">import</span> spatial
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> pygame<span class="token punctuation">,</span> numpy<span class="token punctuation">,</span> pygame<span class="token punctuation">.</span>sndarray
<span class="token keyword">import</span> cv2
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime
<span class="token keyword">import</span> humanize
<span class="token keyword">import</span> os
<span class="token keyword">import</span> time

<span class="token comment"># Sound signals are based on the most recent video frames from the last N seconds (heartbeat length)</span>
queue_size <span class="token operator">=</span> <span class="token number">5</span>  <span class="token comment"># At 2.5fps this queue will contain frames over past 2 seconds.</span>
frame_queue <span class="token operator">=</span> collections<span class="token punctuation">.</span>deque<span class="token punctuation">(</span>maxlen<span class="token operator">=</span>queue_size<span class="token punctuation">)</span>
dist_thresh <span class="token operator">=</span> <span class="token number">0.1</span>
dist_ceil <span class="token operator">=</span> <span class="token number">0.8</span>


<span class="token keyword">def</span> <span class="token function">distance_between_frames</span><span class="token punctuation">(</span>old_frame<span class="token punctuation">,</span> new_frame<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> spatial<span class="token punctuation">.</span>distance<span class="token punctuation">.</span>cosine<span class="token punctuation">(</span>old_frame<span class="token punctuation">,</span> new_frame<span class="token punctuation">)</span>


<span class="token comment"># Source: https://gist.github.com/nekozing/5774628</span>
<span class="token keyword">def</span> <span class="token function">play_sin_tone</span><span class="token punctuation">(</span>freq_hz<span class="token operator">=</span><span class="token number">440</span><span class="token punctuation">,</span> time_ms<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span> peak<span class="token operator">=</span><span class="token number">4096</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sampleRate <span class="token operator">=</span> <span class="token number">44100</span>
    <span class="token comment"># 44.1kHz, 16-bit signed, mono</span>
    pygame<span class="token punctuation">.</span>mixer<span class="token punctuation">.</span>pre_init<span class="token punctuation">(</span>sampleRate<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    pygame<span class="token punctuation">.</span>init<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># ?not so sure? if astype int16 not specified sound will get very noisy, because we have defined it as 16 bit mixer at mixer.pre_init()</span>
    <span class="token comment"># ( probably due to int overflow resulting in non continuous sound data)</span>
    arr <span class="token operator">=</span> numpy<span class="token punctuation">.</span>array<span class="token punctuation">(</span>
        <span class="token punctuation">[</span>
            peak <span class="token operator">*</span> numpy<span class="token punctuation">.</span>sin<span class="token punctuation">(</span><span class="token number">2.0</span> <span class="token operator">*</span> numpy<span class="token punctuation">.</span>pi <span class="token operator">*</span> freq_hz <span class="token operator">*</span> x <span class="token operator">/</span> sampleRate<span class="token punctuation">)</span>
            <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> sampleRate<span class="token punctuation">)</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>numpy<span class="token punctuation">.</span>int16<span class="token punctuation">)</span>
    sound <span class="token operator">=</span> pygame<span class="token punctuation">.</span>sndarray<span class="token punctuation">.</span>make_sound<span class="token punctuation">(</span>arr<span class="token punctuation">)</span>
    <span class="token comment"># ?not so sure? -1 means loop unlimited times</span>
    sound<span class="token punctuation">.</span>play<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    pygame<span class="token punctuation">.</span>time<span class="token punctuation">.</span>delay<span class="token punctuation">(</span>time_ms<span class="token punctuation">)</span>
    sound<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">sound_alert</span><span class="token punctuation">(</span>dist<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> dist <span class="token operator">&lt;</span> dist_thresh<span class="token punctuation">:</span>
        freq_hz <span class="token operator">=</span> <span class="token number">2</span>  <span class="token comment"># basically silence. is inaudible. playing something to make sure bluetooth devices don't disconnect.</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        freq_hz <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>
            <span class="token number">4000</span><span class="token punctuation">,</span> <span class="token number">200</span> <span class="token operator">+</span> <span class="token punctuation">(</span>dist <span class="token operator">-</span> dist_thresh<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">4000</span> <span class="token operator">/</span> <span class="token punctuation">(</span>dist_ceil <span class="token operator">-</span> dist_thresh<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    play_sin_tone<span class="token punctuation">(</span>freq_hz<span class="token punctuation">)</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"dist=</span><span class="token interpolation"><span class="token punctuation">{</span>dist<span class="token punctuation">}</span></span><span class="token string"> freq_hz=</span><span class="token interpolation"><span class="token punctuation">{</span>freq_hz<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">quantize_frame</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>frame <span class="token operator">//</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span>


<span class="token keyword">def</span> <span class="token function">get_next_frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Screencapture the Quicktime window (assumes it is the first one). The app does not have to be in the foreground.</span>
    os<span class="token punctuation">.</span>system<span class="token punctuation">(</span>
        <span class="token triple-quoted-string string">"""screencapture -x -l$(osascript -e 'tell app "Quicktime Player" to id of window 1') screenshot.png"""</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">return</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">"screenshot.png"</span><span class="token punctuation">)</span>


img_counter <span class="token operator">=</span> <span class="token number">0</span>
last_moved_time<span class="token punctuation">,</span> last_moved_dist <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span>

<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    <span class="token comment"># Low frame rate is good. A very high frame rate can cause false negatives.</span>
    <span class="token comment"># Also sleeping between frames lowers CPU utilization.</span>
    start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    frame <span class="token operator">=</span> get_next_frame<span class="token punctuation">(</span><span class="token punctuation">)</span>
    frame_capture_timedelta <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.4</span> <span class="token operator">-</span> frame_capture_timedelta<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># Convert to grayscale. Color is not very useful.</span>
    frame <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2GRAY<span class="token punctuation">)</span>
    <span class="token comment"># Downscale and quantize to reduce noise.</span>
    downscaled_width<span class="token punctuation">,</span> downscaled_height <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>
        frame<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">300</span> <span class="token operator">/</span> frame<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
    frame <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>
        frame<span class="token punctuation">,</span>
        dsize<span class="token operator">=</span><span class="token punctuation">(</span>downscaled_width<span class="token punctuation">,</span> downscaled_height<span class="token punctuation">)</span><span class="token punctuation">,</span>
        interpolation<span class="token operator">=</span>cv2<span class="token punctuation">.</span>INTER_CUBIC<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    frame <span class="token operator">=</span> quantize_frame<span class="token punctuation">(</span>frame<span class="token punctuation">)</span>

    <span class="token comment"># Flatten frame for vector computation later on.</span>
    frame <span class="token operator">=</span> frame<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token punctuation">)</span>
    frame_queue<span class="token punctuation">.</span>append<span class="token punctuation">(</span>frame<span class="token punctuation">)</span>
    img_counter <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>frame_queue<span class="token punctuation">)</span> <span class="token operator">&lt;</span> queue_size<span class="token punctuation">:</span>
        <span class="token keyword">continue</span>

    <span class="token comment"># Calculate vector distance between farthest frames in the queue.</span>
    <span class="token comment"># The higher the distance the more the movement.</span>
    dist <span class="token operator">=</span> distance_between_frames<span class="token punctuation">(</span>frame_queue<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> frame_queue<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment"># Generate an alert sound (if necessary) based on the distance measure.</span>
    sound_alert<span class="token punctuation">(</span>dist<span class="token punctuation">)</span>

    <span class="token comment"># For debugging</span>
    cv2<span class="token punctuation">.</span>imwrite<span class="token punctuation">(</span><span class="token string">"screenshot_mod.jpg"</span><span class="token punctuation">,</span> frame<span class="token punctuation">)</span>
    <span class="token keyword">if</span> last_moved_time<span class="token punctuation">:</span>
        timedelta <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> last_moved_time
        msg <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"Moved </span><span class="token interpolation"><span class="token punctuation">{</span>humanize<span class="token punctuation">.</span>naturaltime<span class="token punctuation">(</span>timedelta<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> (</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">round</span><span class="token punctuation">(</span>last_moved_dist<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">)"</span></span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>

    <span class="token keyword">if</span> dist <span class="token operator">></span> dist_thresh<span class="token punctuation">:</span>
        last_moved_time <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>
        last_moved_dist <span class="token operator">=</span> dist</span></span></span></code></pre><div id="https://www.notion.so/56ae717b80244bcdafb2ce41860706f6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h3 id="https://www.notion.so/10afbf5577994051b7ae1d32f657172e" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/10afbf5577994051b7ae1d32f657172e"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">How this works</span></span></h3><div id="https://www.notion.so/01bd864e9f7b438e9d6e80dc4c579c66" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Screenshots of the Quicktime app are grabbed every 0.4s. These are placed in a queue and the first and last frame that are 2s apart are compared for changes every-time a new frame is queued. The images are processed (color channel conversion, resizing, quantizing, flattening) and cosine distance between frames is calculated as a proxy for movement. The more the movement the higher the pitch of the alert tone. Low distance values do not trigger an alert.</span></span></p></div><div id="https://www.notion.so/2856f474905d4b548758d37c551ec422" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/5c2d2cae91ce4625850261c12dd980e8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The key trick here is the rescaling and quantization. If you zoom into any camera&#x27;s video feed in low light you can see noise - basically  the camera hallucinating pixel values due to weak signal (lack of photons). Noisy images of the same scene will always be far away in vector space. To bring them closer we quantize the values to so they fall into fewer buckets. Here I map 255 different values a grayscale pixel can have down to 25. The downscaling of the video feed also ignores small noisy changes to the image like a piece of cloth flapping in the wind, that are unrelated to the child&#x27;s movement.</span></span></p></div><h3 id="https://www.notion.so/ae218627877046709cefea74a8932535" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/ae218627877046709cefea74a8932535"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Running the monitor</span></span></h3><div id="https://www.notion.so/eef56a4ec20d454fb3dacea330f4c40d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">I try to use magic numbers sparingly. If you run my script it should work reasonably well for you.  Here&#x27;s how:</span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/e32e3ff720434de28aa89aefc3bc0e31" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">Open your favorite iOS baby monitor app on your iPhone.</span></span></li><li id="https://www.notion.so/a6bf395533cd49d68ec7a859279155e5" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">Zoom into the video feed to show your baby&#x27;s sleep area.</span></span></li><li id="https://www.notion.so/cb77663ab97048f78665fd737595d58c" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">Open Quicktime and select File → New Video Recording. Select the iPhone as input.</span></span></li><li id="https://www.notion.so/c00773c70d5b4ec180b3a296de26aa68" class="NumberedList" value="4"><span class="SemanticStringArray"><span class="SemanticString">Install dependencies and run the python script. Check the distance measures logged to stdout.</span></span></li></ol><div id="https://www.notion.so/47c39ddfccb14046921dfa478a001f05" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Reach out if you need help with the set up.</span></span></p></div><div id="https://www.notion.so/56bc19f9759c417c861e84465a666b0b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/cde6266e5bed4055af0344479ad9b831" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">I&#x27;m surprised something like this doesn&#x27;t exist already. Making sure your child is safe is a top concern for every parent. Parenting is hard, labor intensive and it feels like there is no place for repetitive task automation. But this is one of those rare solutions that has brought me peace and calm. Hope this helps other exhausted anxious parents out there. ✌️!</span></span></p></div><div id="https://www.notion.so/7b14b23d0a514e2aa80e6e177356d598" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/8d4f0ee556634daa960ff21768e9b851" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Sesh</span></span></p></div><div id="https://www.notion.so/72ce19664d3e42218286636364827b42" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/309ef91da19243e2bd9808a28f8955f5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/16943df73d9b4c8d92d1831785128e51" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div></article>
      <div id="disqus_thread" width='200' class="PageRoot"></div>
    <script>
        var disqus_config = function () {
        this.page.url = 'https://seshadri.xyz/better-baby-movement-monitor.html';  // page's canonical URL variable
        this.page.identifier = 'seshadri.xyz/better-baby-movement-monitor.html'; // page's unique identifier variable
        };
        
        (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://seshadri-xyz.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


  <footer class="Footer">
  <div>&copy; unvarnished </div> <div>&centerdot;</div> seshadri.xyz <div>&centerdot;</div> 2021</div>
</footer>
</body>

</html>